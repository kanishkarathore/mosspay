<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Vendor Dashboard{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="dashboard-body">

    <aside class="sidebar" id="sidebar">
        <!-- ... Sidebar content remains the same ... -->
    </aside>

    <div class="main-content">
        <header class="main-header">
             <!-- ... Header content remains the same ... -->
        </header>
        <main class="content-body">
            {% block vendor_content %}{% endblock %}
        </main>
    </div>

    <!-- NEW: Generate Bill Modal Structure -->
    <div id="generate-bill-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content large-modal">
            <h3>Generate New Bill</h3>
            <button class="modal-close-btn" id="bill-modal-close-btn">&times;</button>

            <div class="bill-generator-modal-body">
                <!-- Search Bar -->
                <div class="search-bar modal-search">
                    <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="bill-item-search" placeholder="Search item...">
                </div>

                <!-- Item List (will be populated by JS) -->
                <div class="modal-item-list scrollable-list" id="modal-item-list">
                    <!-- Items will appear here -->
                    <p class="no-items-text">Loading items...</p>
                </div>

                <!-- Bill Summary -->
                <div class="bill-summary-modal">
                    <h4>Current Bill Items</h4>
                    <div id="modal-bill-summary" class="modal-bill-summary scrollable-list">
                        <p class="empty-bill-modal">No items added yet.</p>
                    </div>
                    <div class="bill-total modal-total">
                        <span>Total</span>
                        <span id="modal-bill-total">₹0.00</span>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                 <button type="button" class="btn-secondary" id="bill-modal-cancel-btn">Cancel</button>
                 <div id="bill-final-actions" class="bill-final-actions">
                    <button type="button" class="action-btn-secondary" id="generate-qr-btn">Generate QR</button>
                    <button type="button" class="action-btn-primary" id="send-mobile-btn">Send to Mobile</button>
                </div>
            </div>

            <!-- QR Code Display Area (Hidden initially) -->
            <div id="qr-code-display" style="display: none; text-align: center; margin-top: 20px;">
                <h4>Scan QR Code to Pay</h4>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=ExampleMossPayBillData" alt="QR Code Placeholder">
                <p><small>(This is a placeholder QR code)</small></p>
            </div>
        </div>
    </div>
    <!-- End of Modal -->

    <script>
        // --- Sidebar Toggle Script ---
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menu-toggle');
        if (menuToggle) {
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('is-open');
            });
        }

        // --- Generate Bill Modal Script ---
        document.addEventListener('DOMContentLoaded', () => {
            const generateBillBtn = document.getElementById('generate-bill-btn'); // Needs ID on dashboard button
            const billModal = document.getElementById('generate-bill-modal');
            const closeBtn = document.getElementById('bill-modal-close-btn');
            const cancelBtn = document.getElementById('bill-modal-cancel-btn');
            const modalItemList = document.getElementById('modal-item-list');
            const billSummaryEl = document.getElementById('modal-bill-summary');
            const totalAmountEl = document.getElementById('modal-bill-total');
            const itemSearchInput = document.getElementById('bill-item-search');
            const generateQrBtn = document.getElementById('generate-qr-btn');
            const sendMobileBtn = document.getElementById('send-mobile-btn');
            const qrCodeDisplay = document.getElementById('qr-code-display');

            let allItemsData = []; // To store items fetched from Flask
            let currentBill = new Map(); // Map to store {itemId: quantity}

            // Function to populate the item list in the modal
            const populateItemList = (items) => {
                allItemsData = items; // Store for searching
                modalItemList.innerHTML = ''; // Clear loading/previous items
                if (!items || items.length === 0) {
                     modalItemList.innerHTML = '<p class="no-items-text">No items found. Add items via Manage Items page.</p>';
                     return;
                }
                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'modal-item-row';
                    itemDiv.dataset.itemId = item.id;
                    itemDiv.dataset.itemName = item.item_name;
                    itemDiv.dataset.itemPrice = item.price;

                    itemDiv.innerHTML = `
                        <div class="modal-item-info">
                            <span>${item.item_name}</span>
                            <small>₹${parseFloat(item.price).toFixed(2)} / ${item.unit || 'pc'}</small>
                        </div>
                        <div class="quantity-controls">
                            <button class="quantity-btn decrease-btn" data-item-id="${item.id}">-</button>
                            <span class="quantity-display" id="qty-${item.id}">0</span>
                            <button class="quantity-btn increase-btn" data-item-id="${item.id}">+</button>
                        </div>
                    `;
                    modalItemList.appendChild(itemDiv);
                });
            };

            // Function to update the bill summary and total
            const updateBillSummary = () => {
                billSummaryEl.innerHTML = '';
                let total = 0;
                let itemCount = 0;

                if (currentBill.size === 0) {
                     billSummaryEl.innerHTML = '<p class="empty-bill-modal">No items added yet.</p>';
                } else {
                    currentBill.forEach((quantity, itemId) => {
                        const itemData = allItemsData.find(item => item.id == itemId); // Find item details
                        if (itemData && quantity > 0) {
                            itemCount++;
                            const itemTotal = itemData.price * quantity;
                            total += itemTotal;

                            const itemEl = document.createElement('div');
                            itemEl.className = 'modal-summary-item';
                            itemEl.innerHTML = `
                                <span>${quantity} x ${itemData.item_name}</span>
                                <span>₹${itemTotal.toFixed(2)}</span>
                            `;
                            billSummaryEl.appendChild(itemEl);
                        }
                    });
                     if (itemCount === 0) { // Handle case where all quantities are zero
                         billSummaryEl.innerHTML = '<p class="empty-bill-modal">No items added yet.</p>';
                     }
                }
                totalAmountEl.innerText = `₹${total.toFixed(2)}`;
                // Enable/disable final action buttons based on total
                generateQrBtn.disabled = total <= 0;
                sendMobileBtn.disabled = total <= 0;
            };

            // Event listener for opening the modal
            if (generateBillBtn) {
                generateBillBtn.addEventListener('click', () => {
                    // Populate items when modal opens
                    // The 'items' variable needs to be available globally or passed differently
                    // For now, assuming 'vendorItems' is passed to the template and available
                    if (typeof vendorItems !== 'undefined') {
                        populateItemList(vendorItems);
                    } else {
                         modalItemList.innerHTML = '<p class="no-items-text">Error loading items.</p>';
                    }
                    currentBill.clear(); // Start with empty bill
                    updateBillSummary();
                    qrCodeDisplay.style.display = 'none'; // Hide QR on open
                    billModal.style.display = 'flex';
                });
            }

             // Event listener for closing the modal
            const closeModal = () => {
                billModal.style.display = 'none';
                itemSearchInput.value = ''; // Clear search
                filterItemList(''); // Reset item list filter
                qrCodeDisplay.style.display = 'none'; // Hide QR code area
            };
            closeBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            billModal.addEventListener('click', (e) => {
                if (e.target === billModal) closeModal();
            });

            // Event listeners for quantity buttons (using delegation)
            modalItemList.addEventListener('click', (e) => {
                const target = e.target;
                const itemId = target.dataset.itemId;
                if (!itemId) return;

                let currentQuantity = currentBill.get(parseInt(itemId)) || 0;

                if (target.classList.contains('increase-btn')) {
                    currentQuantity++;
                } else if (target.classList.contains('decrease-btn')) {
                    currentQuantity = Math.max(0, currentQuantity - 1); // Don't go below 0
                }

                currentBill.set(parseInt(itemId), currentQuantity);

                // Update the quantity display next to the button
                const qtyDisplay = document.getElementById(`qty-${itemId}`);
                if (qtyDisplay) qtyDisplay.textContent = currentQuantity;

                updateBillSummary(); // Recalculate total and update summary
            });
            
            // Search functionality
            const filterItemList = (searchTerm) => {
                const term = searchTerm.toLowerCase();
                const itemsInList = modalItemList.querySelectorAll('.modal-item-row');
                itemsInList.forEach(itemDiv => {
                    const itemName = itemDiv.dataset.itemName.toLowerCase();
                    if (itemName.includes(term)) {
                        itemDiv.style.display = 'flex'; // Show item
                    } else {
                        itemDiv.style.display = 'none'; // Hide item
                    }
                });
            };
            itemSearchInput.addEventListener('input', (e) => {
                filterItemList(e.target.value);
            });

            // Final action buttons
             generateQrBtn.addEventListener('click', () => {
                // In a real app, generate QR based on bill details
                qrCodeDisplay.style.display = 'block';
                // Maybe scroll to QR code
                qrCodeDisplay.scrollIntoView({ behavior: 'smooth' });
             });

             sendMobileBtn.addEventListener('click', () => {
                const mobileNumber = prompt("Enter customer's mobile number:");
                if (mobileNumber) {
                    // In a real app, send bill details via SMS/API
                    alert(`Bill details would be sent to ${mobileNumber}. (Feature not implemented)`);
                    closeModal(); // Close modal after action
                }
             });

        });
    </script>
    {% block scripts %}{% endblock %}

</body>
</html>